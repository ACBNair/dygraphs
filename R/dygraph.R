 

#' @importFrom magrittr %>%
#' @export %>%
#' 
#' @export
dygraph <- function(data, title = NULL, width = NULL, height = NULL) {
  
  # convert to xts
  if (!is.xts(data))
    data <- as.xts(data)
  
  # check periodicity 
  periodicity <- periodicity(data)
  
  # convert time string we can pass to javascript Date function and
  # extract core data from xts object
  time <- format(time(data), format="%a, %d %b %Y %H:%M:%S GMT", tz='GMT')
  data <- coredata(data)
  
  # calculate column names
  colNames <- colnames(data)
  if (is.null(colNames))
    colNames <- paste("V", 1:ncol(data), sep="")
  
  # merge time into data then strip the metadata (so that the data is 
  # marshalled as a 2d array into json)
  data <- cbind(time, as.data.frame(data), stringsAsFactors = FALSE)
  data <- unclass(data)
  names(data) <- NULL
  
  # convert to native dygraph json options format
  x <- list()
  x$file <- data
  x$title <- title
  x$labels <- c(periodicity$label, colNames)
  if (length(colNames) > 1)
    x$legend <- "always"
  x$axes$x <- list()
  
  # side data we use in javascript
  meta <- list()
  meta$scale <- periodicity$scale
  x$meta <- meta
  
  # create widget
  htmlwidgets::createWidget(
    name = "dygraphs",
    x = x,
    width = width,
    height = height,
    htmlwidgets::sizingPolicy(viewer.padding = 10, browser.fill = TRUE)
  )
}

#' @export
dyAxis <- function(dygraph, 
                   name, 
                   label = NULL, 
                   drawGrid = NULL,
                   pixelsPerLabel = NULL) {
  
  # axis options
  options <- list()
  options[[sprintf("%slabel", name)]] <- label
  options$axes[[name]]$pixelsPerLabel <- pixelsPerLabel
  options$axes[[name]]$drawGrid <- drawGrid
  
  # merge with main options
  dygraph$x <- mergeLists(dygraph$x, options)
  dygraph
}

#' @export
dySeries <- function(dygraph, 
                     name = NULL, 
                     label = NULL, 
                     fillGraph = NULL, 
                     strokeWidth = NULL, 
                     drawPoints = NULL, 
                     pointSize = NULL,
                     highlightCircleSize = NULL) {
  
  # we can deduce the name only if there is one series
  if (is.null(name)) {
    if (length(dygraph$x$labels) == 2)
      name <- dygraph$x$labels[[2]]
    else
      stop("More than one series so must specify a series name")
  } 
  
  # replace default label (this also becomes the name)
  if (!is.null(label)) {
    dygraph$x$labels[dygraph$x$labels == name] <- label
    name <- label
  }
  
  # per-series options
  options <- list()
  options$fillGraph <- fillGraph
  options$strokeWidth <- strokeWidth
  options$drawPoints <- drawPoints
  options$pointSize <- pointSize
  options$highlightCircleSize <- highlightCircleSize
  dygraph$x$series[[name]] <- options
  
  # return modified dygraph
  dygraph
}

#' @export
dyLegend <- function(dygraph, always = FALSE, hideOnMouseOut = TRUE) {
  
  # legend options
  options <- list()
  options$legend <- ifelse(always, "always", "onmouseover")
  options$hideOverlayOnMouseOut <- hideOnMouseOut
  
  # merge with main options
  dygraph$x <- mergeLists(dygraph$x, options)
  dygraph
}

#' @export
dyRangeSelector <- function(dygraph,
                            height = 40,  
                            plotFillColor = "#A7B1C4", 
                            plotStrokeColor = "#A7B1C4") {
  options <- list()
  options$showRangeSelector <- TRUE
  options$rangeSelectorHeight <- height
  options$rangeSelectorPlotFillColor <- plotFillColor
  options$rangeSelectorPlotStrokeColor <- plotStrokeColor
  dygraph$x <- mergeLists(dygraph$x, options)
  dygraph
}

#' @export
dyRoll <- function(dygraph, rollPeriod = 1, showRoller = FALSE) {
  options <- list()
  options$rollPeriod = rollPeriod
  options$showRoller = showRoller
  dygraph$x <- mergeLists(dygraph$x, options)
  dygraph
}


#' @export
dyOptions <- function(dygraph, ...) {
  dygraph$x <- mergeLists(dygraph$x, list(...))
  dygraph
}

#' @export
dygraphOutput <- function(outputId, width = "100%", height = "400px") {
  htmlwidgets::shinyWidgetOutput(outputId, "dygraphs", width, height)
}

#' @export
renderDygraph <- function(expr, env = parent.frame(), quoted = FALSE) {
  if (!quoted) { expr <- substitute(expr) } # force quoted
  htmlwidgets::shinyRenderWidget(expr, dygraphOutput, env, quoted = TRUE)
}
